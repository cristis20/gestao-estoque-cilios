<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestão de Estoque</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body{font-family:Arial,sans-serif;background:#ffe6f0;margin:0;padding:10px;}
h1{text-align:center;color:#d6336c;}
.container{max-width:950px;margin:0 auto;background:#fff0f6;padding:15px;border-radius:15px;box-shadow:0 0 15px rgba(198,77,123,0.3);}
.form-container{border:2px solid #ffc0cb;border-radius:15px;padding:10px;margin-bottom:15px;background:#fffafa;overflow-x:auto;}
.form-row{display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;}
.form-row>div{flex:1;min-width:80px;}
label{display:block;margin-bottom:4px;font-size:14px;color:#800040;}
input[type=text], input[type=number]{width:100%;padding:5px;border-radius:8px;border:1px solid #ffc0cb;box-sizing:border-box;background-color: rgba(255,255,255,0.9);}
.buttons-row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;justify-content:center;}
.buttons-row button{flex:1;min-width:120px;}
table{width:100%;border-collapse:collapse;margin-top:10px;overflow-x:auto;display:block;}
th, td{border:1px solid #f5c6d0;padding:5px;text-align:center;white-space:nowrap;}
th{background:#ffc0cb;color:#800040;}
.btn{cursor:pointer;border:none;border-radius:8px;padding:10px;font-weight:bold;transition:.3s;}
.btn:hover{opacity:.9;}
.add{background:#ff69b4;color:white;} .edit{background:#ff85c1;color:white;} .delete{background:#ff4d6d;color:white;} .clear{background:#c71585;color:white;}
.verde{background-color:#d4f0dc;} .amarelo{background-color:#fff0b3;} .vermelho{background-color:#ffc1c1;}
tr.selected{background-color:#ffe0ed !important;box-shadow:inset 0 0 5px #d6336c;}
select{background-color:#ffe6f0;color:#800040;width:100%;padding:5px;border-radius:8px;border:1px solid #ffc0cb;box-sizing:border-box;}
.total-container{margin-top:10px;font-weight:bold;color:#800040;font-size:16px;text-align:right;}
footer{text-align:center;margin-top:15px;color:#800040;font-size:13px;}
</style>
</head>
<body>
<div class="container">
<h1>Gestão de Estoque</h1>
<div class="form-container">
  <div class="form-row">
    <div>
      <label>Produto:</label>
      <input type="text" id="produto" maxlength="50" placeholder="Código">
    </div>
    <div>
      <label>Descrição:</label>
      <input type="text" id="descricao" maxlength="200" placeholder="Descrição">
    </div>
  </div>
  <div class="form-row">
    <div>
      <label>Estoque Atual:</label>
      <input type="number" id="estoqueAtual" min="0" step="1">
    </div>
    <div>
      <label>Estoque Ideal:</label>
      <input type="number" id="estoqueIdeal" min="0" step="1">
    </div>
    <div>
      <label>Preço (R$):</label>
      <input type="text" id="preco" placeholder="R$ 0,00">
    </div>
  </div>
  <div class="buttons-row">
    <button class="btn add" onclick="adicionarProduto()">Adicionar</button>
    <button class="btn clear" onclick="limparTudo()">Limpar Tudo</button>
    <button class="btn" onclick="baixarExcel()">Baixar Excel</button>
  </div>
</div>

<label>Filtrar produtos:</label>
<select id="filtro" onchange="atualizarTabela()">
  <option value="todos">Todos</option>
  <option value="comprar">Só Precisa Comprar</option>
  <option value="ok">Só OK</option>
</select>

<table id="tabela">
  <thead>
    <tr>
      <th>Produto</th>
      <th>Estoque Atual</th>
      <th>Estoque Ideal</th>
      <th>Preço (R$)</th>
      <th>Qtd a Comprar</th>
      <th>Valor Total (R$)</th>
      <th>Status</th>
      <th>Ações</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<div class="total-container" id="totalGeral">Valor Total Geral: R$ 0,00</div>
<footer id="versao"></footer>
</div>

<script>
let produtos = JSON.parse(localStorage.getItem('produtos')) || [];
let editIndex = null;

function salvar(){ localStorage.setItem('produtos',JSON.stringify(produtos)); atualizarTabela(); }
function limparCampos(){ 
  ['produto','descricao','estoqueAtual','estoqueIdeal','preco'].forEach(id=>{
    document.getElementById(id).value=''; 
    document.getElementById(id).disabled=false;
  }); 
  editIndex=null; 
}
function limparTudo(){ if(confirm('Apagar todos os produtos?')){ produtos=[]; salvar(); limparCampos(); } }
function corLinha(p){ if(p.estoqueAtual<p.estoqueIdeal) return 'vermelho'; if(p.estoqueAtual===p.estoqueIdeal) return 'amarelo'; return 'verde'; }
function parsePreco(v){ 
  const n=parseFloat(v.replace(/\./g,'').replace('R$','').replace(',','.').trim()); 
  return isNaN(n)?NaN:n; 
}
function checarDuplicadoProduto(produto){ 
  return produtos.some((p,i)=>p.produto.trim().toLowerCase()===produto.trim().toLowerCase() && i!==editIndex); 
}

document.getElementById('preco').addEventListener('input', e=>{
  let v=e.target.value.replace(/\D/g,'');
  v=(v/100).toFixed(2)+'';
  v=v.replace('.',',');
  v=v.replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  e.target.value='R$ '+v;
});

document.getElementById('produto').addEventListener('input', function(){
  const codigo = this.value.trim().toLowerCase();
  const produtoExistente = produtos.find(p => p.produto.trim().toLowerCase() === codigo);

  if(produtoExistente){
    document.getElementById('descricao').value = produtoExistente.descricao;
    document.getElementById('estoqueAtual').value = produtoExistente.estoqueAtual;
    document.getElementById('estoqueIdeal').value = produtoExistente.estoqueIdeal;
    document.getElementById('preco').value = 'R$ '+produtoExistente.preco.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    ['descricao','estoqueAtual','estoqueIdeal','preco'].forEach(id => document.getElementById(id).disabled = true);
    editIndex = produtos.indexOf(produtoExistente);
  } else {
    ['descricao','estoqueAtual','estoqueIdeal','preco'].forEach(id => {
      document.getElementById(id).disabled = false;
      document.getElementById(id).value = '';
    });
    editIndex = null;
  }
});

function adicionarProduto(){
  const produto=document.getElementById('produto').value.trim();
  const descricao=document.getElementById('descricao').value.trim();
  const estoqueAtual=parseInt(document.getElementById('estoqueAtual').value);
  const estoqueIdeal=parseInt(document.getElementById('estoqueIdeal').value);
  const preco=parsePreco(document.getElementById('preco').value);

  if(!produto){ alert('Informe o código do produto'); return; }
  if(isNaN(estoqueAtual)){ alert('Informe o estoque atual'); return; }
  if(isNaN(estoqueIdeal)){ alert('Informe o estoque ideal'); return; }
  if(isNaN(preco)){ alert('Informe o preço válido'); return; }
  if(checarDuplicadoProduto(produto)){ alert('Produto já cadastrado!'); return; }

  const novo={produto,descricao,estoqueAtual,estoqueIdeal,preco:parseFloat(preco.toFixed(2))};
  if(editIndex!==null){ produtos[editIndex]=novo; editIndex=null; } else { produtos.push(novo); }
  salvar(); limparCampos();
}

function editarProduto(index){
  const p=produtos[index];
  document.getElementById('produto').value=p.produto;
  document.getElementById('descricao').value=p.descricao;
  document.getElementById('estoqueAtual').value=p.estoqueAtual;
  document.getElementById('estoqueIdeal').value=p.estoqueIdeal;
  document.getElementById('preco').value='R$ '+p.preco.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
  ['descricao','estoqueAtual','estoqueIdeal','preco'].forEach(id => document.getElementById(id).disabled = false);
  editIndex=index;
}

function excluirProduto(index){ 
  if(confirm('Deseja excluir?')){ 
    produtos.splice(index,1); 
    salvar(); 
    editIndex=null; 
    limparCampos(); 
  } 
}

function atualizarTabela(){
  const tbody=document.querySelector('#tabela tbody'); 
  tbody.innerHTML='';
  const filtro=document.getElementById('filtro').value;
  let totalGeral = 0;

  produtos.forEach((p,idx)=>{
    const qtdComprar=p.estoqueAtual<p.estoqueIdeal?p.estoqueIdeal-p.estoqueAtual:0;
    if(filtro==='comprar' && qtdComprar<=0) return;
    if(filtro==='ok' && qtdComprar>0) return;

    const valorTotal = qtdComprar*p.preco;
    totalGeral += valorTotal;

    const valorTotalStr = valorTotal.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
    const tr=document.createElement('tr'); 
    tr.className=corLinha(p);
    tr.innerHTML=`
      <td>${p.produto}</td>
      <td>${p.estoqueAtual}</td>
      <td>${p.estoqueIdeal}</td>
      <td>R$ ${p.preco.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.')}</td>
      <td>${qtdComprar}</td>
      <td>R$ ${valorTotalStr}</td>
      <td>${qtdComprar>0?'Comprar':'OK'}</td>
      <td>
        <button class="btn edit" onclick="editarProduto(${idx})">Editar</button>
        <button class="btn delete" onclick="excluirProduto(${idx})">Excluir</button>
      </td>
    `;

    tr.addEventListener('click', ()=>{
      document.querySelectorAll('#tabela tbody tr').forEach(r=>r.classList.remove('selected'));
      tr.classList.add('selected');
      editarProduto(idx);
    });

    tbody.appendChild(tr);
  });

  document.getElementById('totalGeral').textContent = 
    'Valor Total Geral: R$ '+totalGeral.toFixed(2).replace('.',',').replace(/\B(?=(\d{3})+(?!\d))/g,'.');
}

// ---------- Atualização automática ----------
setInterval(() => {
  fetch(window.location.href + '?v=' + Date.now(), {cache: 'no-store'})
    .then(response => response.text())
    .then(html => {
      if (!html.includes('Versão 1.0.2')) {
        console.log('Nova versão detectada! Atualizando...');
        window.location.reload(true);
      }
    })
    .catch(err => console.warn('Erro ao verificar nova versão:', err));
}, 60000);

// ---------- Rodapé automático ----------
const hoje = new Date();
const dataFormatada = hoje.toLocaleDateString('pt-BR');
document.getElementById('versao').textContent = `Versão 1.0.2 - Atualizado em ${dataFormatada}`;

atualizarTabela();
</script>
</body>
</html>
