<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="app-version" content="1.0.1">
  <title>Gestão de Estoque - Rosa Pastel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fff6f9;
      margin: 0;
      padding: 0;
      color: #444;
    }

    h1 {
      text-align: center;
      background-color: #f9dfe8;
      color: #a85d84;
      padding: 10px;
      margin: 0;
      font-size: 1.5rem;
    }

    .container {
      max-width: 900px;
      margin: 20px auto;
      background: #ffffff;
      border: 3px solid #f9dfe8;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(255, 182, 193, 0.3);
    }

    label {
      font-weight: bold;
      color: #a85d84;
    }

    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #f3b2c6;
      border-radius: 8px;
      width: calc(100% - 20px);
      max-width: 200px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }

    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      background-color: #f9dfe8;
      border: 1px solid #f3b2c6;
      border-radius: 8px;
      color: #a85d84;
      padding: 8px 15px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.2s;
    }

    button:hover {
      background-color: #f3b2c6;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th, td {
      border: 1px solid #f3b2c6;
      text-align: center;
      padding: 8px;
    }

    th {
      background-color: #f9dfe8;
      color: #a85d84;
    }

    .total {
      text-align: right;
      font-weight: bold;
      color: #a85d84;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      input {
        width: 48%;
      }
      .buttons {
        justify-content: center;
      }
      button {
        flex: 1;
        min-width: 100px;
      }
    }
  </style>

  <script>
    // Atualização automática de versão (para iPhone e Android)
    (function() {
      const currentVersion = document.querySelector('meta[name="app-version"]').content;
      const savedVersion = localStorage.getItem('app-version');
      if (savedVersion && savedVersion !== currentVersion) {
        localStorage.clear();
        caches.keys().then(keys => keys.forEach(key => caches.delete(key)));
        localStorage.setItem('app-version', currentVersion);
        location.reload(true);
      } else if (!savedVersion) {
        localStorage.setItem('app-version', currentVersion);
      }
    })();

    let produtos = JSON.parse(localStorage.getItem('produtos')) || [];

    function atualizarTabela() {
      const tbody = document.querySelector("#tabelaProdutos tbody");
      tbody.innerHTML = "";
      produtos.forEach((p, index) => {
        const linha = `<tr onclick="selecionarProduto(${index})">
          <td>${p.codigo}</td>
          <td>${p.produto}</td>
          <td>${p.estoqueAtual}</td>
          <td>${p.estoqueIdeal}</td>
          <td>R$ ${p.preco.toFixed(2)}</td>
          <td>${p.comprar}</td>
          <td>R$ ${(p.comprar * p.preco).toFixed(2)}</td>
        </tr>`;
        tbody.innerHTML += linha;
      });
      atualizarTotal();
      salvarLocal();
    }

    function adicionarProduto() {
      const codigo = document.getElementById("codigo").value.trim();
      const produto = document.getElementById("produto").value.trim();
      const estoqueAtual = parseFloat(document.getElementById("estoqueAtual").value) || 0;
      const estoqueIdeal = parseFloat(document.getElementById("estoqueIdeal").value) || 0;
      const preco = parseFloat(document.getElementById("preco").value) || 0;
      const comprar = estoqueIdeal > estoqueAtual ? estoqueIdeal - estoqueAtual : 0;

      if (!codigo || !produto) {
        alert("Preencha o código e o produto.");
        return;
      }

      const existente = produtos.find(p => p.codigo === codigo);
      if (existente) {
        alert("Código já existente!");
        preencherCampos(existente);
        return;
      }

      produtos.push({ codigo, produto, estoqueAtual, estoqueIdeal, preco, comprar });
      atualizarTabela();
      limparCampos();
    }

    function preencherCampos(p) {
      document.getElementById("codigo").value = p.codigo;
      document.getElementById("produto").value = p.produto;
      document.getElementById("estoqueAtual").value = p.estoqueAtual;
      document.getElementById("estoqueIdeal").value = p.estoqueIdeal;
      document.getElementById("preco").value = p.preco.toFixed(2);
    }

    function selecionarProduto(index) {
      preencherCampos(produtos[index]);
    }

    function limparCampos() {
      document.getElementById("codigo").value = "";
      document.getElementById("produto").value = "";
      document.getElementById("estoqueAtual").value = "";
      document.getElementById("estoqueIdeal").value = "";
      document.getElementById("preco").value = "";
    }

    function limparTudo() {
      if (confirm("Deseja realmente apagar todos os dados?")) {
        produtos = [];
        atualizarTabela();
      }
    }

    function salvarLocal() {
      localStorage.setItem("produtos", JSON.stringify(produtos));
    }

    function atualizarTotal() {
      const total = produtos.reduce((acc, p) => acc + (p.comprar * p.preco), 0);
      document.getElementById("total").innerText = "Total a Comprar: R$ " + total.toFixed(2);
    }

    function baixarExcel() {
      let csv = "Código,Produto,Estoque Atual,Estoque Ideal,Preço,Comprar,Total\n";
      produtos.forEach(p => {
        csv += `${p.codigo},${p.produto},${p.estoqueAtual},${p.estoqueIdeal},${p.preco},${p.comprar},${(p.comprar * p.preco).toFixed(2)}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "estoque.csv";
      link.click();
    }

    function verificarCodigo() {
      const codigo = document.getElementById("codigo").value.trim();
      const existente = produtos.find(p => p.codigo === codigo);
      if (existente) {
        alert("Código já existente! Dados carregados.");
        preencherCampos(existente);
      }
    }
  </script>
</head>
<body onload="atualizarTabela()">
  <h1>Gestão de Estoque</h1>

  <div class="container">
    <div class="row">
      <input id="codigo" placeholder="Código" onblur="verificarCodigo()">
      <input id="produto" placeholder="Produto">
    </div>
    <div class="row">
      <input id="estoqueAtual" type="number" placeholder="Estoque Atual">
      <input id="estoqueIdeal" type="number" placeholder="Estoque Ideal">
      <input id="preco" type="number" step="0.01" placeholder="Preço (R$)">
    </div>

    <div class="buttons">
      <button onclick="adicionarProduto()">Adicionar</button>
      <button onclick="limparTudo()">Limpar Tudo</button>
      <button onclick="baixarExcel()">Baixar Excel</button>
    </div>

    <table id="tabelaProdutos">
      <thead>
        <tr>
          <th>Código</th>
          <th>Produto</th>
          <th>Estoque Atual</th>
          <th>Estoque Ideal</th>
          <th>Preço</th>
          <th>Comprar</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div id="total" class="total">Total a Comprar: R$ 0,00</div>
  </div>
</body>
</html>
