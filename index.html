<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Estoque</title>
  <meta name="theme-color" content="#FFB6C1">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #ffe6f0; 
      margin: 0; 
      padding: 20px; 
      overflow-x: hidden;
    }

    h1 { text-align: center; color: #d6336c; }

    .container { 
      max-width: 950px; 
      width: 100%; 
      margin: 0 auto; 
      background: #fff0f6; 
      padding: 20px; 
      border-radius: 15px; 
      box-shadow: 0 0 15px rgba(198, 77, 123, 0.3);
    }

    .form-container {
      border: 2px solid #ffc0cb;
      border-radius: 15px;
      padding: 15px;
      background: #fffafa;
      margin-bottom: 15px;
    }

    .form-row { 
      display: flex; 
      flex-wrap: wrap;
      gap: 10px; 
      margin-bottom: 10px; 
    }

    .form-row > div { 
      flex: 1;
      min-width: 140px;
    }

    label { 
      display: block; 
      margin-bottom: 4px; 
      font-size: 14px;
      color: #800040;
    }

    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ffc0cb;
      box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.9);
    }

    .buttons-row { 
      display: flex; 
      flex-wrap: wrap;
      gap: 10px; 
      margin-bottom: 10px; 
    }
    .buttons-row button { flex: 1; }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 10px; 
      background: #fff; 
      border-radius: 10px; 
      overflow: hidden; 
    }

    th, td { border: 1px solid #f5c6d0; padding: 8px; text-align: center; }
    th { background-color: #ffc0cb; color: #800040; }

    .btn { cursor: pointer; border: none; border-radius: 8px; padding: 10px 15px; font-weight: bold; transition: 0.3s; }
    .btn:hover { opacity: 0.9; }

    .add { background: #ff69b4; color: white; } 
    .edit { background: #ff85c1; color: white; } 
    .delete { background: #ff4d6d; color: white; } 
    .clear { background: #c71585; color: white; }

    .verde { background-color: #d4f0dc; }    
    .amarelo { background-color: #fff0b3; }  
    .vermelho { background-color: #ffc1c1; }

    select { background-color: #ffe6f0; color: #800040; }

    tr.selected { background-color: #ffd6e0; }

    @media (max-width: 600px) {
      body { padding: 10px; }
      .container { padding: 15px; }
      .buttons-row button { flex: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gestão de Estoque</h1>

    <div class="form-container">
      <div class="form-row">
        <div>
          <label>Produto:</label>
          <input type="text" id="produto" maxlength="50" placeholder="Produto (máx 50)">
        </div>
        <div>
          <label>Descrição:</label>
          <input type="text" id="descricao" maxlength="200" placeholder="Descrição (máx 200)">
        </div>
      </div>

      <div class="form-row">
        <div>
          <label>Estoque Atual:</label>
          <input type="number" id="estoqueAtual" step="1" min="0" placeholder="0">
        </div>
        <div>
          <label>Estoque Ideal:</label>
          <input type="number" id="estoqueIdeal" step="1" min="0" placeholder="0">
        </div>
        <div>
          <label>Preço (R$):</label>
          <input type="text" id="preco" placeholder="0,00">
        </div>
      </div>

      <div class="buttons-row">
        <button type="button" class="btn add" onclick="adicionarProduto()">Adicionar</button>
        <button type="button" class="btn clear" onclick="limparTudo()">Limpar Tudo</button>
        <button type="button" class="btn" onclick="baixarExcel()">Baixar Excel</button>
      </div>
    </div>

    <label>Filtrar produtos:</label>
    <select id="filtro" onchange="atualizarTabela()">
      <option value="todos">Todos</option>
      <option value="comprar">Só Precisa Comprar</option>
      <option value="ok">Só OK</option>
    </select>

    <table id="tabela">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Estoque Atual</th>
          <th>Estoque Ideal</th>
          <th>Qtd a Comprar</th>
          <th>Preço (R$)</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations){
        for(let registration of registrations) { registration.unregister(); }
      });
    }

    // Carrega e inicializa
    let produtos = JSON.parse(localStorage.getItem('produtos')) || [];
    let editIndex = null;

    function salvar() {
      localStorage.setItem('produtos', JSON.stringify(produtos));
      atualizarTabela();
    }

    // Função para converter input de preço aceitando vírgula ou ponto e limpar espaços
    function parsePreco(valorStr) {
      if (typeof valorStr !== 'string') return NaN;
      const s = valorStr.trim().replace(/\s/g, '').replace(',', '.');
      const v = parseFloat(s);
      return isNaN(v) ? NaN : v;
    }

    function adicionarProduto() {
      const produto = document.getElementById('produto').value.trim();
      const descricao = document.getElementById('descricao').value.trim();

      const estoqueAtualRaw = document.getElementById('estoqueAtual').value;
      const estoqueIdealRaw = document.getElementById('estoqueIdeal').value;
      const precoRaw = document.getElementById('preco').value;

      const estoqueAtual = estoqueAtualRaw === '' ? NaN : parseInt(estoqueAtualRaw, 10);
      const estoqueIdeal = estoqueIdealRaw === '' ? NaN : parseInt(estoqueIdealRaw, 10);
      const preco = parsePreco(precoRaw);

      // Validação
      if (!produto) { alert('Informe o nome do produto.'); return; }
      if (isNaN(estoqueAtual)) { alert('Informe o Estoque Atual.'); return; }
      if (isNaN(estoqueIdeal)) { alert('Informe o Estoque Ideal.'); return; }
      if (isNaN(preco)) { alert('Informe o Preço válido (use , ou . para decimais).'); return; }

      const novoProduto = {
        produto,
        descricao,
        estoqueAtual,
        estoqueIdeal,
        preco: Number(preco.toFixed(2))
      };

      if (editIndex !== null) {
        produtos[editIndex] = novoProduto;
        editIndex = null;
      } else {
        produtos.push(novoProduto);
      }

      salvar();
      limparCampos();
    }

    function editarProduto(index) {
      const p = produtos[index];
      if (!p) return;
      document.getElementById('produto').value = p.produto;
      document.getElementById('descricao').value = p.descricao;
      document.getElementById('estoqueAtual').value = p.estoqueAtual;
      document.getElementById('estoqueIdeal').value = p.estoqueIdeal;
      // mostra com vírgula para o usuário
      document.getElementById('preco').value = (typeof p.preco === 'number') ? p.preco.toFixed(2).replace('.', ',') : '';
      editIndex = index;
      // marca a linha
      document.querySelectorAll('#tabela tbody tr').forEach(r => r.classList.remove('selected'));
      const rows = Array.from(document.querySelectorAll('#tabela tbody tr'));
      if (rows[index]) rows[index].classList.add('selected');
    }

    function excluirProduto(index) {
      if (!confirm('Deseja excluir este produto?')) return;
      produtos.splice(index, 1);
      salvar();
      editIndex = null;
      limparCampos();
    }

    function limparCampos() {
      document.getElementById('produto').value = '';
      document.getElementById('descricao').value = '';
      document.getElementById('estoqueAtual').value = '';
      document.getElementById('estoqueIdeal').value = '';
      document.getElementById('preco').value = '';
      document.querySelectorAll('#tabela tbody tr').forEach(r => r.classList.remove('selected'));
    }

    function limparTudo() {
      if (!confirm('Tem certeza que deseja apagar todos os produtos?')) return;
      produtos = [];
      salvar();
      limparCampos();
    }

    function corLinha(p) {
      if (p.estoqueAtual < p.estoqueIdeal) return 'vermelho';
      if (p.estoqueAtual === p.estoqueIdeal) return 'amarelo';
      return 'verde';
    }

    function atualizarTabela() {
      const tbody = document.querySelector('#tabela tbody');
      tbody.innerHTML = '';

      const produtosOrdenados = [...produtos].sort((a,b) => a.produto.localeCompare(b.produto));
      const filtro = document.getElementById('filtro').value;

      produtosOrdenados.forEach((p, idx) => {
        const quantidadeComprar = p.estoqueAtual < p.estoqueIdeal ? (p.estoqueIdeal - p.estoqueAtual) : 0;
        if (filtro === 'comprar' && quantidadeComprar <= 0) return;
        if (filtro === 'ok' && quantidadeComprar > 0) return;

        const tr = document.createElement('tr');
        tr.className = corLinha(p);

        const precoFormatado = (typeof p.preco === 'number') ? p.preco.toFixed(2).replace('.', ',') : '0,00';

        tr.innerHTML = `
          <td>${p.produto}</td>
          <td>${p.estoqueAtual}</td>
          <td>${p.estoqueIdeal}</td>
          <td class='${quantidadeComprar>0?'vermelho':''}'>${quantidadeComprar}</td>
          <td>R$ ${precoFormatado}</td>
          <td>${quantidadeComprar>0 ? 'Comprar' : 'OK'}</td>
          <td>
            <button type="button" class="btn edit" onclick="editarProduto(${produtos.indexOf(p)})">Editar</button>
            <button type="button" class="btn delete" onclick="excluirProduto(${produtos.indexOf(p)})">Excluir</button>
          </td>`;

        // clicar na linha preenche o topo (mesma função de editar)
        tr.addEventListener('click', () => {
          const indexOriginal = produtos.indexOf(p);
          editarProduto(indexOriginal);
        });

        tbody.appendChild(tr);
      });
    }

    function baixarExcel() {
      if (produtos.length === 0) { alert('Não há produtos para baixar!'); return; }

      const dados = produtos.map(p => {
        const quantidadeComprar = p.estoqueAtual < p.estoqueIdeal ? (p.estoqueIdeal - p.estoqueAtual) : 0;
        return {
          'Produto': p.produto,
          'Descrição': p.descricao,
          'Estoque Atual': p.estoqueAtual,
          'Estoque Ideal': p.estoqueIdeal,
          'Quantidade a Comprar': quantidadeComprar,
          'Preço (R$)': (typeof p.preco === 'number') ? p.preco.toFixed(2) : '',
          'Status': quantidadeComprar > 0 ? 'Comprar' : 'OK'
        };
      });

      const ws = XLSX.utils.json_to_sheet(dados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Estoque');
      XLSX.writeFile(wb, 'estoque.xlsx');
    }

    // inicial
    atualizarTabela();
  </script>
</body>
</html>
