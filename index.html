<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestão de Estoque</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFB6C1">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <link rel="apple-touch-icon" sizes="180x180" href="icon-512.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #ffe6f0; 
      margin: 0; 
      padding: 20px; 
      overflow-x: hidden; 
    }

    h1 { text-align: center; color: #d6336c; }

    .container { 
      max-width: 950px; 
      width: 100%; 
      margin: 0 auto; 
      background: #fff0f6; 
      padding: 20px; 
      border-radius: 15px; 
      box-shadow: 0 0 15px rgba(198, 77, 123, 0.3);
    }

    .form-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: flex-end; }
    .form-row label { display: block; margin-bottom: 2px; }

    input[type="text"], input[type="number"], select {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ffc0cb;
      box-sizing: border-box;
      background-color: rgba(255, 255, 255, 0.85);
    }

    input#produto { width: 100px; }
    input#descricao { width: 350px; }
    input#estoqueAtual, input#estoqueIdeal { width: 60px; }

    .buttons-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .buttons-row button { flex: 1; }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      margin-top: 5px; 
      background: #fff; 
      border-radius: 10px; 
      overflow: hidden; 
    }

    th, td { border: 1px solid #f5c6d0; padding: 8px; text-align: center; box-sizing: border-box; }
    th { background-color: #ffc0cb; color: #800040; }

    /* Larguras fixas para alinhar com inputs */
    table th:nth-child(1), table td:nth-child(1) { width: 100px; }   /* Produto */
    table th:nth-child(2), table td:nth-child(2) { width: 60px; }    /* Estoque Atual */
    table th:nth-child(3), table td:nth-child(3) { width: 60px; }    /* Estoque Ideal */
    table th:nth-child(4), table td:nth-child(4) { width: 80px; }    /* Qtd a Comprar */
    table th:nth-child(5), table td:nth-child(5) { width: 60px; }    /* Status */
    table th:nth-child(6), table td:nth-child(6) { width: 140px; }   /* Ações */

    .btn { cursor: pointer; border: none; border-radius: 8px; padding: 10px 15px; font-weight: bold; transition: 0.3s; }
    .btn:hover { opacity: 0.9; }

    .add { background: #ff69b4; color: white; } 
    .edit { background: #ff85c1; color: white; } 
    .delete { background: #ff4d6d; color: white; } 
    .clear { background: #c71585; color: white; }

    .verde { background-color: #d4f0dc; }    
    .amarelo { background-color: #fff0b3; }  
    .vermelho { background-color: #ffc1c1; }

    select { background-color: #ffe6f0; color: #800040; }

    tr.selected { background-color: #ffd6e0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Gestão de Estoque</h1>

    <div class="form-row">
      <div>
        <label>Produto:</label>
        <input type="text" id="produto" maxlength="10" size="10" placeholder="Produto (máx 10)">
      </div>
      <div>
        <label>Descrição:</label>
        <input type="text" id="descricao" maxlength="35" size="35" placeholder="Descrição (máx 35)">
      </div>
    </div>

    <div class="form-row">
      <div>
        <label>Estoque Atual:</label>
        <input type="number" id="estoqueAtual" step="1" min="0" size="4" placeholder="0">
      </div>
      <div>
        <label>Estoque Ideal:</label>
        <input type="number" id="estoqueIdeal" step="1" min="0" size="4" placeholder="0">
      </div>
    </div>

    <div class="buttons-row">
      <button class="btn add" onclick="adicionarProduto()">Adicionar</button>
      <button class="btn clear" onclick="limparTudo()">Limpar Tudo</button>
      <button class="btn" onclick="baixarExcel()">Baixar Excel</button>
    </div>

    <label>Filtrar produtos:</label>
    <select id="filtro" onchange="atualizarTabela()">
      <option value="todos">Todos</option>
      <option value="comprar">Só Precisa Comprar</option>
      <option value="ok">Só OK</option>
    </select>

    <table id="tabela">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Estoque Atual</th>
          <th>Estoque Ideal</th>
          <th>Quantidade a Comprar</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations){
        for(let registration of registrations) { registration.unregister(); }
      });
    }

    let produtos = JSON.parse(localStorage.getItem('produtos')) || [];
    let editIndex = null;

    function salvar() { 
      localStorage.setItem('produtos', JSON.stringify(produtos)); 
      atualizarTabela(); 
    }

    function adicionarProduto() {
      const produto = document.getElementById('produto').value.trim();
      const descricao = document.getElementById('descricao').value.trim();
      const estoqueAtual = parseInt(document.getElementById('estoqueAtual').value);
      const estoqueIdeal = parseInt(document.getElementById('estoqueIdeal').value);
      if (!produto || isNaN(estoqueAtual) || isNaN(estoqueIdeal)) { 
        alert('Preencha todos os campos!'); 
        return; 
      }
      const novoProduto = { produto, descricao, estoqueAtual, estoqueIdeal };
      if (editIndex !== null) { 
        produtos[editIndex] = novoProduto; 
        editIndex = null; 
      } else { 
        produtos.push(novoProduto); 
      }
      salvar(); 
      limparCampos();
    }

    function editarProduto(index) {
      const p = produtos[index];
      document.getElementById('produto').value = p.produto;
      document.getElementById('descricao').value = p.descricao;
      document.getElementById('estoqueAtual').value = p.estoqueAtual;
      document.getElementById('estoqueIdeal').value = p.estoqueIdeal;
      editIndex = index;
    }

    function excluirProduto(index) { 
      if(confirm('Deseja excluir este produto?')) { 
        produtos.splice(index, 1); 
        salvar(); 
      } 
    }

    function limparCampos() {
      document.getElementById('produto').value='';
      document.getElementById('descricao').value='';
      document.getElementById('estoqueAtual').value='';
      document.getElementById('estoqueIdeal').value='';
    }

    function limparTudo() { 
      if(confirm('Tem certeza que deseja apagar todos os produtos?')) { 
        produtos = []; 
        salvar(); 
      } 
    }

    function corLinha(p) { 
      if(p.estoqueAtual < p.estoqueIdeal) return 'vermelho'; 
      if(p.estoqueAtual === p.estoqueIdeal) return 'amarelo'; 
      return 'verde'; 
    }

    function atualizarTabela() {
      const tbody = document.querySelector('#tabela tbody'); 
      tbody.innerHTML='';

      const produtosOrdenados = [...produtos].sort((a,b) => a.produto.localeCompare(b.produto));

      const filtro = document.getElementById('filtro').value;
      produtosOrdenados.forEach((p,index)=>{
        const quantidadeComprar = p.estoqueAtual < p.estoqueIdeal ? (p.estoqueIdeal - p.estoqueAtual) : 0;
        if(filtro==='comprar' && quantidadeComprar<=0) return;
        if(filtro==='ok' && quantidadeComprar>0) return;
        const tr=document.createElement('tr'); 
        tr.className=corLinha(p);
        tr.innerHTML=`
          <td>${p.produto}</td>
          <td>${p.estoqueAtual}</td>
          <td>${p.estoqueIdeal}</td>
          <td class='${quantidadeComprar>0?'vermelho':''}'>${quantidadeComprar}</td>
          <td>${quantidadeComprar>0?'Comprar':'OK'}</td>
          <td>
            <button class='btn edit' onclick='editarProduto(${produtos.indexOf(p)})'>Editar</button>
            <button class='btn delete' onclick='excluirProduto(${produtos.indexOf(p)})'>Excluir</button>
          </td>`;

        tr.addEventListener('click', () => {
          document.getElementById('produto').value = p.produto;
          document.getElementById('descricao').value = p.descricao;
          document.getElementById('estoqueAtual').value = p.estoqueAtual;
          document.getElementById('estoqueIdeal').value = p.estoqueIdeal;
          editIndex = produtos.indexOf(p);

          document.querySelectorAll('#tabela tbody tr').forEach(r => r.classList.remove('selected'));
          tr.classList.add('selected');
        });

        tbody.appendChild(tr);
      });
    }

    function baixarExcel() {
      if (produtos.length === 0) { alert('Não há produtos para baixar!'); return; }

      const dados = produtos.map(p => {
        const quantidadeComprar = p.estoqueAtual < p.estoqueIdeal ? (p.estoqueIdeal - p.estoqueAtual) : 0;
        return {
          'Produto': p.produto,
          'Descrição': p.descricao,
          'Estoque Atual': p.estoqueAtual,
          'Estoque Ideal': p.estoqueIdeal,
          'Quantidade a Comprar': quantidadeComprar,
          'Status': quantidadeComprar>0?'Comprar':'OK'
        };
      });

      const ws = XLSX.utils.json_to_sheet(dados);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Estoque');
      XLSX.writeFile(wb, 'estoque.xlsx');
    }

    atualizarTabela();
  </script>
</body>
</html>
